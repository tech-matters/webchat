<html>
<head>
    <title>My chat</title>
</head>
<body>
    <script src="https://media.twiliocdn.com/sdk/js/flex-webchat/releases/2.1.2/twilio-flex-webchat.min.js"></script>
    <script>
      const translations = {
        'en-US': {
          BotGreeting: "How can I help?",
          WelcomeMessage: "Welcome to Toronto Line!",
          MessageCanvasTrayContent: "<p>The counselor has left the chat. Thank you for reaching out. Please contact us again if you need more help.</p>",
        },
        'es': {
          EntryPointTagline: "Chatea con nosotros",
          MessageCanvasTrayButton: "EMPEZAR NUEVO CHAT",
          InvalidPreEngagementMessage: "Los formularios previos al compromiso no se han establecido y son necesarios para iniciar el chat web. Por favor configúrelos ahora en la configuración.",
          InvalidPreEngagementButton: "Aprende más",
          PredefinedChatMessageAuthorName: "Bot",
          PredefinedChatMessageBody: "¡Hola! ¿Cómo podemos ayudarte hoy?",
          InputPlaceHolder: "Escribe un mensaje",
          TypingIndicator: "{0} está escribiendo ... ",
          Read: "Visto",
          MessageSendingDisabled: "El envío de mensajes ha sido desactivado",
          Today: "HOY",
          Yesterday: "AYER",
          Save: "GUARDAR",
          Reset: "RESETEAR",
          MessageCharacterCountStatus: "{{currentCharCount}} / {{maxCharCount}}",
          SendMessageTooltip: "Enviar Mensaje",
          FieldValidationRequiredField: "Campo requerido",
          FieldValidationInvalidEmail: "Por favor provea una dirección válida de email",

          PreEngagementDescription: "Comencemos",

          BotGreeting: "¿Cómo puedo ayudar?",
          WelcomeMessage: "¡Bienvenido a Toronto Line!",
          MessageCanvasTrayContent: "<p>El consejero abandonó el chat. Gracias por contactarnos. Por favor contáctenos nuevamente si necesita más ayuda.</p>",
        },
        'dk': {
          MessageCanvasTrayContent: "<p>Rådgiveren har forladt chatten. Tak, fordi du nåede ud. Kontakt os igen, hvis du har brug for mere hjælp.</p>",
        }
      }

      const appConfig = {
        accountSid:"AC6b99858a6faf7af1b572c83988b50eb1",
        flexFlowSid:"FO57c22d5dfc7a18dcada507aa70ca0cb3",
        startEngagementOnInit: false,
        preEngagementConfig: {
          description: "Let's get started",
          fields:
            [{
              label: "What is your helpline?",
              type: "SelectItem",
              attributes: {
                name: "helpline",
                required: true,
                readOnly: false
              },
              options: 
              [
                {
                  value: "Select helpline",
                  label: "Select helpline",
                  selected: true
                },
                {
                  value: "Børns Vilkår (DK)",
                  label: "Børns Vilkår (DK)",
                  selected: false
                },
                {
                  value: "Childhelp (US)",
                  label: "Childhelp (US)",
                  selected: false
                },
                {
                  value: "CHILDLINE India (IN)",
                  label: "CHILDLINE India (IN)",
                  selected: false
                },
                {
                  value: "Childline South Africa (SA)",
                  label: "Childline South Africa (SA)",
                  selected: false
                },
                {
                  value: "ChildLine Zambia (ZM)",
                  label: "ChildLine Zambia (ZM)",
                  selected: false
                },
                {
                  value: "Child Helpline Cambodia (KH)",
                  label: "Child Helpline Cambodia (KH)",
                  selected: false
                },
                {
                  value: "Jordan River 110 (JO)",
                  label: "Jordan River 110 (JO)",
                  selected: false
                },
                {
                  value: "SMILE OF THE CHILD (GR)",
                  label: "SMILE OF THE CHILD (GR)",
                  selected: false
                },
                {
                  value: "Telefono Azzurro (IT)",
                  label: "Telefono Azzurro (IT)",
                  selected: false
                },
                {
                  value: "BRIS (SE)",
                  label: "BRIS (SE)",
                  selected: false
                },
                {
                  value: "2NDFLOOR (US)",
                  label: "2NDFLOOR (US)",
                  selected: false
                },
                {
                  value: "Palo Alto Testing (Text)",
                  label: "Palo Alto Testing (Text)",
                  selected: false
                }
              ]
            }],
          submitLabel: "Let's chat!"
        }
      };


      const defaultLanguage = 'en-US';
      const initialLanguage = defaultLanguage;

      const mapHelplineLanguage = helpline => {
        switch (helpline) {
          case 'Palo Alto Testing (Text)':
            return 'en-US';
          default:
            return defaultLanguage;
        }
      }

      Twilio.FlexWebChat.createWebChat(appConfig).then(webchat => {
        const { manager } = webchat;

        const twilioStrings = { ...manager.strings }; // save the originals
        const setNewStrings = newStrings => (manager.strings = { ...manager.strings, ...newStrings });
        const translationErrorMsg = 'Could not translate, using default';

        const changeLanguageWebChat = language => {
          try {
            if (language !== defaultLanguage && translations[language]) {
              setNewStrings({ ...twilioStrings, ...translations[defaultLanguage], ...translations[language] });
            } else {
              setNewStrings({ ...twilioStrings, ...translations[defaultLanguage] });
            }
            Twilio.FlexWebChat.MessagingCanvas.defaultProps.predefinedMessage.body =
              (translations[language] && translations[language].BotGreeting) || translations[defaultLanguage].BotGreeting;
            console.log('Translation OK');
          } catch (err) {
            window.alert(translationErrorMsg);
            console.error(translationErrorMsg, err);
            changeLanguageWebChat(defaultLanguage)
          }
        }

        changeLanguageWebChat(initialLanguage);

        //Posting question from preengagement form as users first chat message
        Twilio.FlexWebChat.Actions.on("afterStartEngagement", (payload) => {
          const { question, helpline } = payload.formData;

          // here we might collect caller language (from a another preEngagement select)
          const helplineLanguage = mapHelplineLanguage(helpline);
          changeLanguageWebChat(helplineLanguage);

          if (!question)
            return;

          const { channelSid } = manager.store.getState().flex.session;
          manager
            .chatClient.getChannelBySid(channelSid)
            .then(channel => channel.sendMessage(question));
        });

        // Render WebChat
        webchat.init();
      });
    </script>
</body>
</html>