<html>
<head>
    <title>My chat</title>
</head>
<body>
    <script src="https://media.twiliocdn.com/sdk/js/flex-webchat/releases/2.1.2/twilio-flex-webchat.min.js"></script>
    <script>
        const translations = {
          'en-US': {
            BotGreeting: "How can I help?",
            WelcomeMessage: "Welcome to Toronto Line!",
            MessageCanvasTrayContent: "<p>The counselor has left the chat. Thank you for reaching out. Please contact us again if you need more help.</p>",
          },
          'es': {
            EntryPointTagline: "Chatea con nosotros",
            MessageCanvasTrayButton: "EMPEZAR NUEVO CHAT",
            InvalidPreEngagementMessage: "Los formularios previos al compromiso no se han establecido y son necesarios para iniciar el chat web. Por favor configúrelos ahora en la configuración.",
            InvalidPreEngagementButton: "Aprende más",
            PredefinedChatMessageAuthorName: "Bot",
            PredefinedChatMessageBody: "¡Hola! ¿Cómo podemos ayudarte hoy?",
            InputPlaceHolder: "Escribe un mensaje",
            TypingIndicator: "{0} está escribiendo ... ",
            Read: "Visto",
            MessageSendingDisabled: "El envío de mensajes ha sido desactivado",
            Today: "HOY",
            Yesterday: "AYER",
            Save: "GUARDAR",
            Reset: "RESETEAR",
            MessageCharacterCountStatus: "{{currentCharCount}} / {{maxCharCount}}",
            SendMessageTooltip: "Enviar Mensaje",
            FieldValidationRequiredField: "Campo requerido",
            FieldValidationInvalidEmail: "Por favor provea una dirección válida de email",

            PreEngagementDescription: "Comencemos",

            BotGreeting: "¿Cómo puedo ayudar?",
            WelcomeMessage: "¡Bienvenido a Toronto Line!",
            MessageCanvasTrayContent: "<p>El consejero abandonó el chat. Gracias por contactarnos. Por favor contáctenos nuevamente si necesita más ayuda.</p>",
          }
        }

        const defaultLanguage = 'en-US';
        // const defaultLanguage = 'es';
        // const userLanguage = window.navigator.language;
        // console.log(userLanguage)
        // const webchatLanguage = 
        //   translations.userLanguage ? userLanguage : userLanguage.slice(0, 2) ? userLanguage.slice(0, 2) : defaultLanguage;
        const webchatLanguage = defaultLanguage;

        const appConfig = {
            accountSid:"ACd8a2e89748318adf6ddff7df6948deaf",
            flexFlowSid:"FO8c2d9c388e7feba8b08d06a4bc3f69d1",
            startEngagementOnInit: false,
            preEngagementConfig: {
                description: translations[webchatLanguage].PreEngagementDescription,
                fields:
                    [{
                      label: "What is your helpline?",
                        type: "SelectItem",
                        attributes: 
                        {
                            name: "helpline",
                            required: true,
                            readOnly: false
                        },
                        options: [
                        {
                            value: "Select helpline",
                            label: "Select helpline",
                            selected: true
                        },
                        {
                            value: "Fake Helpline",
                            label: "Fake Helpline",
                            selected: false
                        },
                        ]
                    }],
                submitLabel: "Let's chat!"
            }
        };

        const mapHelplineLanguage = helpline => {
          switch (helpline) {
            case 'Fake Helpline':
              return 'es';
            default:
              return defaultLanguage;
          }
        }

        Twilio.FlexWebChat.createWebChat(appConfig).then(webchat => {
            const { manager } = webchat;
            
            const twilioStrings = { ...manager.strings }; // save the originals
            const setNewStrings = newStrings => (manager.strings = { ...manager.strings, ...newStrings });
            const translationErrorMsg = 'Could not translate, using default';

            const changeLanguageWebChat = language => {
              try {
                let translation;
                if (language === defaultLanguage) {
                  translation = { ...twilioStrings, ...translations[defaultLanguage] };
                } else {
                  translation = translations[language];
                }
                setNewStrings(translation)
                Twilio.FlexWebChat.MessagingCanvas.defaultProps.predefinedMessage.body = translation.BotGreeting;
                console.log('Translation OK');
              } catch (err) {
                changeLanguageWebChat(defaultLanguage)
                window.alert(translationErrorMsg);
                console.error(translationErrorMsg, err);
              }
            }

              //Posting question from preengagement form as users first chat message
              Twilio.FlexWebChat.Actions.on("afterStartEngagement", (payload) => {
                  const { question, helpline } = payload.formData;

                  // here we might collect caller language (from a another preEngagement select)
                  const helplineLanguage = mapHelplineLanguage(helpline);
                  changeLanguageWebChat(helplineLanguage);

                  if (!question)
                      return;

                  const { channelSid } = manager.store.getState().flex.session;
                  manager
                      .chatClient.getChannelBySid(channelSid)
                      .then(channel => channel.sendMessage(question));
              });

              // Render WebChat
              webchat.init();
        });
    </script>
</body>
</html>