<html>
<head>
    <title>My chat</title>
</head>
<body>
    <script src="https://assets.flex.twilio.com/releases/flex-webchat-ui/2.6.0/twilio-flex-webchat.min.js"></script>
    <script>
      const translations = {
        'en-US': {
          WelcomeMessage: "Welcome to Aselo!",
          MessageCanvasTrayContent: "<p>The counselor has left the chat. Thank you for reaching out. Please contact us again if you need more help.</p>",
          MessageInputDisabledReasonHold: "Please hold for a counselor.",
          AutoFirstMessage: "Incoming webchat contact",
        },
      }

      const defaultLanguage = 'en-US';
      const initialLanguage = defaultLanguage;

      const appConfig = {
        accountSid:"ACc59300c7ca018e8652e4d6d86c2d50e6",
        flexFlowSid:"FObb9dfe97f1c59f455ab01811bec74cd5",
        startEngagementOnInit: false,
        preEngagementConfig: {
          description: "Let's get started",
          fields:
            [
              {
                label: "What is your name?",
                type: "InputItem",
                attributes: {
                  name: "friendlyName",
                  type: "text",
                  required: false
                }
              }
            ],
          submitLabel: "Let's chat!"
        }
      };

      const mapHelplineLanguage = helpline => {
        switch (helpline) {
          default:
            return defaultLanguage;
        }
      }

      const getChangeLanguageWebChat = manager => language => {
        const twilioStrings = { ...manager.strings }; // save the originals
        const setNewStrings = newStrings => (manager.strings = { ...manager.strings, ...newStrings });
        const translationErrorMsg = 'Could not translate, using default';
        
        try {
          if (language !== defaultLanguage && translations[language]) {
            setNewStrings({ ...twilioStrings, ...translations[defaultLanguage], ...translations[language] });
          } else {
            setNewStrings({ ...twilioStrings, ...translations[defaultLanguage] });
          }

          console.log('Translation OK');
        } catch (err) {
          window.alert(translationErrorMsg);
          console.error(translationErrorMsg, err);
          changeLanguageWebChat(defaultLanguage)
        }
      }

      const doWithChannel = callback => manager => {
        const { channelSid } = manager.store.getState().flex.session;
          manager
            .chatClient.getChannelBySid(channelSid)
            .then(channel => {
              callback(channel, manager);
            });
      }

      const unlockInput = (manager) => {
        const { user } = manager.chatClient;
        const { lockInput, ...attributes } = user.attributes;
        user.updateAttributes(attributes);
      }

      const setListenerToUnlockInput = (channel, manager) => {
        if (!channel) return;

        const cb = () => {
          // Re-enable input
          unlockInput(manager)
        }

        // User is not alone in the channel (possible cause to enter this case is page reload)
        if (channel.members.size > 1) {
          cb();
          return;
        }
       
        // Adds an event listener that will run only once
        channel.once("memberJoined", () => {
          cb();
        });
      }

      const setChannelOnCreateWebChat = doWithChannel(setListenerToUnlockInput);

      const setChannelAfterStartEngagement = doWithChannel((channel, manager) => {
        setListenerToUnlockInput(channel, manager);

        // Generate task by sending empty message (hidden from the UI above)
        channel.sendMessage(translations[initialLanguage].AutoFirstMessage);
      })

      Twilio.FlexWebChat.createWebChat(appConfig).then(webchat => {
        const { manager } = webchat;
        const changeLanguageWebChat = getChangeLanguageWebChat(manager);

        changeLanguageWebChat(initialLanguage);

        // If caller is waiting for a counselor to connect, disable input (default language)
        if (manager.chatClient) setChannelOnCreateWebChat(manager);

        // Disable greeting message as chatbot already includes one
        Twilio.FlexWebChat.MessagingCanvas.defaultProps.predefinedMessage = false;

        // Set caller name to be 'You'
        Twilio.FlexWebChat.MessagingCanvas.defaultProps.memberDisplayOptions = {
          yourDefaultName: 'You',
          yourFriendlyNameOverride: false,
          theirFriendlyNameOverride: true,
        };

        // Hide message input and send button if disabledReason is not undefined
        Twilio.FlexWebChat.MessageInput.Content.remove('textarea', {
          if: props => manager.chatClient.user.attributes.lockInput,
        });

        // Hide first message ("AutoFirstMessage", sent to create a new task)
        Twilio.FlexWebChat.MessageList.Content.remove('0');

        // Posting question from preengagement form as users first chat message
        Twilio.FlexWebChat.Actions.on("afterStartEngagement", (payload) => {
          const { question, helpline } = payload.formData;

          // Here we might collect caller language (from a another preEngagement select)
          const helplineLanguage = mapHelplineLanguage(helpline);
          changeLanguageWebChat(helplineLanguage);

          setChannelAfterStartEngagement(manager);
        });

        // Render WebChat
        webchat.init();
      });
    </script>
</body>
</html>
