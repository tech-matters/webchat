<html>
<head>
    <title>My chat</title>
</head>
<body>
    <script src="https://media.twiliocdn.com/sdk/js/flex-webchat/releases/2.1.2/twilio-flex-webchat.min.js"></script>
    <script>
      const translations = {
        'en-US': {
          BotGreeting: "Welcome to the helpline.  A counselor will be with you shortly.",
          WelcomeMessage: "Welcome to Aselo!",
          MessageCanvasTrayContent: "<p>The counselor has left the chat. Thank you for reaching out. Please contact us again if you need more help.</p>",
          MessageInputDisabledReasonHold: "Please hold for a counselor.",
          AutoFirstMessage: "Incoming webchat contact",
        },
        'es': {
          EntryPointTagline: "Chatea con nosotros",
          MessageCanvasTrayButton: "EMPEZAR NUEVO CHAT",
          InvalidPreEngagementMessage: "Los formularios previos al compromiso no se han establecido y son necesarios para iniciar el chat web. Por favor configúrelos ahora en la configuración.",
          InvalidPreEngagementButton: "Aprende más",
          PredefinedChatMessageAuthorName: "Bot",
          PredefinedChatMessageBody: "¡Hola! ¿Cómo podemos ayudarte hoy?",
          InputPlaceHolder: "Escribe un mensaje",
          TypingIndicator: "{0} está escribiendo ... ",
          Read: "Visto",
          MessageSendingDisabled: "El envío de mensajes ha sido desactivado",
          Today: "HOY",
          Yesterday: "AYER",
          Save: "GUARDAR",
          Reset: "RESETEAR",
          MessageCharacterCountStatus: "{{currentCharCount}} / {{maxCharCount}}",
          SendMessageTooltip: "Enviar Mensaje",
          FieldValidationRequiredField: "Campo requerido",
          FieldValidationInvalidEmail: "Por favor provea una dirección válida de email",

          PreEngagementDescription: "Comencemos",

          BotGreeting: "¿Cómo puedo ayudar?",
          WelcomeMessage: "¡Bienvenido a Aselo!",
          MessageCanvasTrayContent: "<p>El consejero abandonó el chat. Gracias por contactarnos. Por favor contáctenos nuevamente si necesita más ayuda.</p>",
        },
        'dk': {
          MessageCanvasTrayContent: "<p>Rådgiveren har forladt chatten. Tak, fordi du nåede ud. Kontakt os igen, hvis du har brug for mere hjælp.</p>",
        }
      }

      const defaultLanguage = 'en-US';
      const initialLanguage = defaultLanguage;

      const appConfig = {
        accountSid:"ACd8a2e89748318adf6ddff7df6948deaf",
        flexFlowSid:"FO8c2d9c388e7feba8b08d06a4bc3f69d1",
        startEngagementOnInit: false,
        preEngagementConfig: {
          description: "Let's get started",
          fields:
            [{
              label: "What is your helpline?",
              type: "SelectItem",
              attributes:
              {
                name: "helpline",
                required: true,
                readOnly: false
              },
              options: [
                {
                  value: "Select helpline",
                  label: "Select helpline",
                  selected: true
                },
                {
                  value: "Fake Helpline",
                  label: "Fake Helpline",
                  selected: false
                },
              ]
            }],
          submitLabel: "Let's chat!"
        }
      };

      const mapHelplineLanguage = helpline => {
        switch (helpline) {
          case 'Fake Helpline':
            return 'dk';
          default:
            return defaultLanguage;
        }
      }

      const getChangeLanguageWebChat = manager => language => {
        const twilioStrings = { ...manager.strings }; // save the originals
        const setNewStrings = newStrings => (manager.strings = { ...manager.strings, ...newStrings });
        const translationErrorMsg = 'Could not translate, using default';
        
        try {
          if (language !== defaultLanguage && translations[language]) {
            setNewStrings({ ...twilioStrings, ...translations[defaultLanguage], ...translations[language] });
          } else {
            setNewStrings({ ...twilioStrings, ...translations[defaultLanguage] });
          }
          Twilio.FlexWebChat.MessagingCanvas.defaultProps.predefinedMessage.body =
            (translations[language] && translations[language].BotGreeting) || translations[defaultLanguage].BotGreeting;
          console.log('Translation OK');
        } catch (err) {
          window.alert(translationErrorMsg);
          console.error(translationErrorMsg, err);
          changeLanguageWebChat(defaultLanguage)
        }
      }

      const doWithChannel = callback => manager => {
        const { channelSid } = manager.store.getState().flex.session;
          manager
            .chatClient.getChannelBySid(channelSid)
            .then(channel => {
              callback(channel, manager);
            });
      }

      const unlockInput = (manager) => {
        const { user } = manager.chatClient;
        const { lockInput, ...attributes } = user.attributes;
        user.updateAttributes(attributes);
      }

      const setListenerToUnlockInput = (channel, manager) => {
        if (!channel) return;

        if (channel.members.size > 1) {
          unlockInput(manager)
          // Twilio.FlexWebChat.MessageInput.defaultProps.disabledReason = undefined;
          return;
        }
       
        // Adds an event listener that will run only once
        channel.once("memberJoined", () => {
          // Re-enable input
          unlockInput(manager)
          // Twilio.FlexWebChat.MessageInput.defaultProps.disabledReason = undefined;
        });
      }

      const setChannelOnCreateWebChat = doWithChannel(setListenerToUnlockInput);

      const setChannelAfterStartEngagement = doWithChannel((channel, manager) => {
        setListenerToUnlockInput(channel, manager);

        // Generate task by sending empty message (hidden from the UI above)
        channel.sendMessage(translations[initialLanguage].AutoFirstMessage);
      })

      Twilio.FlexWebChat.createWebChat(appConfig).then(webchat => {
        const { manager } = webchat;
        const changeLanguageWebChat = getChangeLanguageWebChat(manager);

        changeLanguageWebChat(initialLanguage);

        // If caller is waiting for a counselor to connect, disable input (default language)
        // Twilio.FlexWebChat.MessageInput.defaultProps.disabledReason = translations[initialLanguage].MessageInputDisabledReasonHold;
        if (manager.chatClient) setChannelOnCreateWebChat(manager);
        
        // Hide message input and send button if disabledReason is not undefined
        Twilio.FlexWebChat.MessageInput.Content.remove('textarea', {
          if: props => manager.chatClient.user.attributes.lockInput,
        });

        // Hide first message ("AutoFirstMessage", sent to create a new task)
        Twilio.FlexWebChat.MessageList.Content.remove('0');

        // Posting question from preengagement form as users first chat message
        Twilio.FlexWebChat.Actions.on("afterStartEngagement", (payload) => {
          const { question, helpline } = payload.formData;

          // Here we might collect caller language (from a another preEngagement select)
          const helplineLanguage = mapHelplineLanguage(helpline);
          changeLanguageWebChat(helplineLanguage);

          // Change disabled message to actual language if it exists, default if not
          const translatedReasonOrDefault = translations[helplineLanguage].MessageInputDisabledReasonHold || translations[initialLanguage].MessageInputDisabledReasonHold;
    // // Twilio.FlexWebChat.MessageInput.defaultProps.disabledReason = translatedReasonOrDefault;
          // Twilio.FlexWebChat.MessageInput.defaultProps.disabledReason = undefined;

          setChannelAfterStartEngagement(manager);
        });

        // Render WebChat
        webchat.init();
      });
    </script>
</body>
</html>