<html>
<head>
    <title>My chat</title>
</head>
<body>
    <script src="https://media.twiliocdn.com/sdk/js/flex-webchat/releases/2.1.2/twilio-flex-webchat.min.js"></script>
    <script>
        const appConfig = {
            accountSid:"ACd8a2e89748318adf6ddff7df6948deaf",
            flexFlowSid:"FO8c2d9c388e7feba8b08d06a4bc3f69d1",
            startEngagementOnInit: false,
            preEngagementConfig: {
                description: "Let's get started",
                fields:
                    [{
                        label: "What is your helpline?",
                        type: "SelectItem",
                        attributes: 
                        {
                            name: "helpline",
                            required: true,
                            readOnly: false
                        },
                        options: [
                        {
                            value: "Select helpline",
                            label: "Select helpline",
                            selected: true
                        }
                        ]
                    }],
                submitLabel: "Let's chat!"
            }
        };
        const defaultLanguage = 'en-US';
        const helplineLanguage = 'es';

        Twilio.FlexWebChat.createWebChat(appConfig).then(webchat => {
            const { manager } = webchat;
            const serverlessBaseUrl = manager.serviceConfiguration.attributes.serverless_base_url;
            
            const twilioStrings = { ...manager.strings }; // save the originals
            const setNewStrings = newStrings => (manager.strings = { ...manager.strings, ...newStrings });
            const translationErrorMsg = 'Could not translate, using default';

            const changeLanguageWebChat = async language => {
              try {
                const response = await fetch(`${serverlessBaseUrl}/translations/${language}/messages.json`);
                const translation = await response.json();
                if (language === defaultLanguage) {
                  setNewStrings({ ...twilioStrings, ...translation });
                } else {
                  setNewStrings(translation);
                }
                Twilio.FlexWebChat.MessagingCanvas.defaultProps.predefinedMessage.body = translation.BotGreeting;
                console.log('Translation OK');
              } catch (err) {
                window.alert(translationErrorMsg);
                console.error(translationErrorMsg, err);
                changeLanguageWebChat(defaultLanguage)
              }
            }

            const webchatLanguage = helplineLanguage || defaultLanguage;
            changeLanguageWebChat(webchatLanguage).then(() =>{
              //Posting question from preengagement form as users first chat message
              Twilio.FlexWebChat.Actions.on("afterStartEngagement", (payload) => {
                  const { question } = payload.formData;
                  if (!question)
                      return;

                  const { channelSid } = manager.store.getState().flex.session;
                  manager
                      .chatClient.getChannelBySid(channelSid)
                      .then(channel => channel.sendMessage(question));
              });

              // Render WebChat
              webchat.init();
            })
        });
    </script>
</body>
</html>